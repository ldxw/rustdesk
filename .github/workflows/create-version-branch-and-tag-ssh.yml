name: æ›´æ–°åˆ†æ”¯å¹¶æ‰“Tagï¼šå­æ¨¡å— + URLæ›¿æ¢ + Tagé”šå®šåˆ†æ”¯HEAD

on:
  workflow_dispatch:
    inputs:
      work_branch:
        description: "è¦æ›´æ–°å¹¶æ‰“Tagçš„åˆ†æ”¯ï¼ˆä¾‹å¦‚ 1.4.2ï¼‰"
        required: true
        default: "1.4.2"

      # ä»…æ›¿æ¢ https://admin.rustdesk.com  
      admin_url:  
        description: "å°†ä»“åº“å†…æ‰€æœ‰ https://admin.rustdesk.com æ›¿æ¢ä¸ºè¯¥åœ°å€ï¼ˆä¸æ”¹å­æ¨¡å—å†…å®¹ï¼‰"  
        required: true  
        default: "https://admin-hy.rs.ldxw.top"  

      # å­æ¨¡å—ï¼ˆå…¬å¼€ä»“åº“ï¼ŒHTTPSï¼‰  
      submodule_url:  
        description: "libs/hbb_common å­æ¨¡å—å…¬å¼€ä»“åº“ï¼ˆHTTPSï¼‰åœ°å€"  
        required: true  
        default: "https://github.com/ldxw/rustdesk_hbb_common.git"  
      submodule_branch:  
        description: "libs/hbb_common å­æ¨¡å—åˆ†æ”¯ï¼ˆauto=è‡ªåŠ¨æ£€æµ‹è¿œç«¯é»˜è®¤åˆ†æ”¯ï¼‰"  
        required: true  
        default: "auto"  

      # æ¨åˆ†æ”¯ä¸æ‰“Tagé€‰é¡¹ï¼ˆâ‰¤10ä¸ªï¼‰  
      push_branch:  
        description: "æ˜¯å¦æ¨é€åˆ†æ”¯ï¼ˆtrue=æ¨ï¼›false=åªæœ¬åœ°æ›´æ”¹ï¼‰"  
        type: choice  
        options: ["true", "false"]  
        required: true  
        default: "true"  
      force:  
        description: "æ¨åˆ†æ”¯/å»ºTagæ˜¯å¦å¼ºåˆ¶ï¼ˆåˆ†æ”¯ç”¨ --force-with-leaseï¼›Tag ç”¨ -fï¼‰"  
        type: choice  
        options: ["false", "true"]  
        required: true  
        default: "false"  
      do_tag:  
        description: "æ˜¯å¦åœ¨åˆ†æ”¯HEADæ‰“Tag"  
        type: choice  
        options: ["true", "false"]  
        required: true  
        default: "true"  
      version:  
        description: "Tag åï¼ˆç•™ç©ºä½¿ç”¨ work_branchï¼‰"  
        required: false  
        default: ""  
      tag_message:  
        description: "Tag æ³¨é‡Š"  
        required: false  
        default: "ä¿®æ”¹å†…ç½®æœåŠ¡å™¨å’Œ key"  
      retag:  
        description: "æ˜¯å¦å¼ºåˆ¶é‡æ‰“Tagï¼ˆå…ˆåˆ è¿œç«¯åŒåTagå†å»ºï¼‰"  
        type: choice  
        options: ["true", "false"]  
        required: true  
        default: "true"

permissions:
  contents: write

jobs:
  update_and_tag:
    runs-on: ubuntu-latest
    env:
      WORK_BRANCH: ${{ inputs.work_branch }}
    steps:
      - name: Checkout repo (no submodules, no persisted creds)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Git identity  
        run: |  
          set -euo pipefail  
          echo -e "\n=================================================="
          echo -e "ğŸ”§ é…ç½®Gitèº«ä»½ä¿¡æ¯"
          echo -e "==================================================\n"
          git config user.name  "github-actions[bot]"  
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"  
          echo "âœ… Gitèº«ä»½é…ç½®å®Œæˆï¼šuser.name=github-actions[bot]ï¼Œuser.email=41898282+github-actions[bot]@users.noreply.github.com"

      - name: Prepare branch locally  
        run: |  
          set -euo pipefail  
          echo -e "\n=================================================="
          echo -e "ğŸ“¦ æœ¬åœ°å‡†å¤‡ç›®æ ‡åˆ†æ”¯ï¼š${WORK_BRANCH}"
          echo -e "==================================================\n"
          
          git fetch origin --no-tags
          echo "âœ… å·²ä»è¿œç«¯æ‹‰å–æœ€æ–°åˆ†æ”¯ä¿¡æ¯"

          if git show-ref --verify --quiet "refs/remotes/origin/${WORK_BRANCH}"; then  
            if git show-ref --verify --quiet "refs/heads/${WORK_BRANCH}"; then  
              git checkout "refs/heads/${WORK_BRANCH}"  
              echo "â„¹ï¸ æœ¬åœ°å·²å­˜åœ¨${WORK_BRANCH}åˆ†æ”¯ï¼Œæ‰§è¡Œå¿«é€Ÿåˆå¹¶è¿œç«¯æ›´æ–°"
              git merge --ff-only "refs/remotes/origin/${WORK_BRANCH}" || true  
            else  
              git checkout -B "${WORK_BRANCH}" "refs/remotes/origin/${WORK_BRANCH}"  
              echo "âœ… æœ¬åœ°ä¸å­˜åœ¨${WORK_BRANCH}åˆ†æ”¯ï¼Œå·²åŸºäºè¿œç«¯åˆ†æ”¯åˆ›å»º"
            fi  
            echo "âœ… ç›®æ ‡åˆ†æ”¯${WORK_BRANCH}æœ¬åœ°å‡†å¤‡å®Œæˆ"
          else  
            echo -e "\n::error::âŒ è¿œç«¯ä¸å­˜åœ¨åˆ†æ”¯ origin/${WORK_BRANCH}ï¼Œæµç¨‹ç»ˆæ­¢"  
            exit 1  
          fi  

      # å­æ¨¡å—ï¼šæŒ‡å‘å…¬å¼€åº“ + æŒ‡å®š/è‡ªåŠ¨åˆ†æ”¯ï¼Œå¹¶æ›´æ–°æŒ‡é’ˆï¼ˆæ—¥å¿—ç¾åŒ–ï¼‰
      - name: Configure submodule and update pointer  
        id: sm_update  
        run: |  
          set -euo pipefail  
          SM_NAME='libs/hbb_common'  
          SM_PATH='libs/hbb_common'  
          SM_URL='${{ inputs.submodule_url }}'  
          REQ_BRANCH='${{ inputs.submodule_branch }}'  

          echo -e "\n=================================================="
          echo -e "ğŸ”— é…ç½®å¹¶æ›´æ–°å­æ¨¡å—ï¼š${SM_PATH}"
          echo -e "ğŸ“Œ ç›®æ ‡å­æ¨¡å—ä»“åº“ï¼š${SM_URL}"
          echo -e "ğŸ“Œ ç›®æ ‡å­æ¨¡å—åˆ†æ”¯ï¼ˆè¾“å…¥ï¼‰ï¼š${REQ_BRANCH}"
          echo -e "==================================================\n"

          if [ ! -f .gitmodules ]; then  
            echo -e "\n::error::âŒ .gitmodules ä¸å­˜åœ¨ï¼Œé¡¹ç›®æœªå£°æ˜å­æ¨¡å—ï¼Œæµç¨‹ç»ˆæ­¢"  
            exit 1  
          fi  
          echo "âœ… æ£€æµ‹åˆ°.gitmodulesæ–‡ä»¶ï¼Œå¼€å§‹å¤„ç†å­æ¨¡å—é…ç½®"

          DETECTED_BRANCH="$REQ_BRANCH"  
          if [ "$REQ_BRANCH" = "auto" ] || ! git ls-remote --heads "${SM_URL}" "${REQ_BRANCH}" | grep -q .; then  
            echo "â„¹ï¸ è‡ªåŠ¨æ£€æµ‹å­æ¨¡å—è¿œç«¯é»˜è®¤åˆ†æ”¯..."
            DETECTED_BRANCH="$(git ls-remote --symref "${SM_URL}" HEAD | awk '/^ref:/ {print $2}' | sed 's#refs/heads/##')"  
            if [ -z "${DETECTED_BRANCH}" ]; then  
              echo -e "\n::error::âŒ æ— æ³•æ£€æµ‹å­æ¨¡å—è¿œç«¯é»˜è®¤åˆ†æ”¯ï¼Œè¯·æ‰‹åŠ¨æŒ‡å®š submodule_branchï¼Œæµç¨‹ç»ˆæ­¢"  
              exit 1  
            fi  
            echo "âœ… è‡ªåŠ¨æ£€æµ‹åˆ°å­æ¨¡å—é»˜è®¤åˆ†æ”¯ï¼š${DETECTED_BRANCH}"
          else
            echo "âœ… å­æ¨¡å—è¿œç«¯å­˜åœ¨æŒ‡å®šåˆ†æ”¯ï¼š${REQ_BRANCH}ï¼Œæ— éœ€è‡ªåŠ¨æ£€æµ‹"
          fi  
          echo "sm_branch=${DETECTED_BRANCH}" >> "$GITHUB_OUTPUT"  

          # é…ç½®å­æ¨¡å—.gitmodulesä¿¡æ¯
          git config -f .gitmodules "submodule.${SM_NAME}.url"    "${SM_URL}"  
          git config -f .gitmodules "submodule.${SM_NAME}.path"   "${SM_PATH}"  
          git config -f .gitmodules "submodule.${SM_NAME}.branch" "${DETECTED_BRANCH}"  
          git add .gitmodules  
          if ! git diff --cached --quiet; then  
            git commit -m "chore(submodule): configure ${SM_PATH} to ${SM_URL} (${DETECTED_BRANCH})"  
            echo "âœ… å·²æäº¤.gitmodulesé…ç½®ä¿®æ”¹"
          else  
            echo "â„¹ï¸ .gitmodulesé…ç½®æ— å˜æ›´ï¼Œæ— éœ€æäº¤"
          fi  

          # åŒæ­¥å¹¶æ›´æ–°å­æ¨¡å—
          echo -e "\nğŸš€ å¼€å§‹åŒæ­¥å¹¶æ›´æ–°å­æ¨¡å—å†…å®¹..."
          git submodule sync -- "${SM_PATH}"  
          git submodule set-url    "${SM_PATH}" "${SM_URL}" || true  
          git submodule set-branch --branch "${DETECTED_BRANCH}" "${SM_PATH}" || true  
          git submodule update --init --remote "${SM_PATH}"  
          echo "âœ… å­æ¨¡å—åŒæ­¥å®Œæˆï¼Œå¼€å§‹æ ¡éªŒå­æ¨¡å—åˆ†æ”¯"

          git -C "${SM_PATH}" fetch origin --no-tags  
          if ! git -C "${SM_PATH}" rev-parse --verify -q "refs/remotes/origin/${DETECTED_BRANCH}" >/dev/null; then  
            echo -e "\n::error::âŒ å­æ¨¡å—è¿œç«¯ä¸å­˜åœ¨åˆ†æ”¯ origin/${DETECTED_BRANCH}ï¼Œæµç¨‹ç»ˆæ­¢"  
            exit 1  
          fi  
          git -C "${SM_PATH}" checkout -B "${DETECTED_BRANCH}" "origin/${DETECTED_BRANCH}"  
          echo "âœ… å­æ¨¡å—å·²åˆ‡æ¢è‡³ç›®æ ‡åˆ†æ”¯ï¼š${DETECTED_BRANCH}"

          git add "${SM_PATH}"  
          if ! git diff --cached --quiet; then  
            git commit -m "chore(submodule): bump ${SM_PATH} to origin/${DETECTED_BRANCH} latest"  
            echo "âœ… å·²æäº¤å­æ¨¡å—æŒ‡é’ˆæ›´æ–°ï¼ˆåŒæ­¥è‡³è¿œç«¯æœ€æ–°ï¼‰"
          else  
            echo "â„¹ï¸ å­æ¨¡å—å·²ä¸ºè¿œç«¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æäº¤"
          fi  

      # ä»…æ›¿æ¢ https://admin.rustdesk.comï¼ˆæ’é™¤å­æ¨¡å—ï¼Œæ—¥å¿—ç¾åŒ–+éšè—åŸŸåï¼‰  
      - name: Replace admin HTTPS URLs (exclude submodule)  
        run: |  
          set -euo pipefail  
          NEW_URL='${{ inputs.admin_url }}'  
          TARGET_OLD_URL="https://admin.rustdesk.com"
          replace_file_count=0

          echo -e "\n=================================================="
          echo -e "ğŸ”„ æ‰§è¡Œadmin HTTPS URLæ›¿æ¢ï¼ˆæ’é™¤å­æ¨¡å— ${SM_PATH}ï¼‰"
          echo -e "ğŸ“Œ å¾…æ›¿æ¢æ—§URLï¼š${TARGET_OLD_URL}"
          echo -e "ğŸ“Œ æ›¿æ¢é€»è¾‘ï¼šä¸æš´éœ²æ–°URLï¼Œä»…æ‰§è¡Œæ‰¹é‡æ›¿æ¢"
          echo -e "==================================================\n"

          # æ£€æµ‹å¹¶ç»Ÿè®¡éœ€æ›¿æ¢æ–‡ä»¶
          files_http=$(git grep -l -E "${TARGET_OLD_URL}" -- ':!:libs/hbb_common' || true)  
          if [ -n "${files_http}" ]; then  
            replace_file_count=$(echo "${files_http}" | wc -w)
            new_esc=${NEW_URL//&/\\&}  
            echo "âœ… æ£€æµ‹åˆ° ${replace_file_count} ä¸ªæ–‡ä»¶éœ€æ›¿æ¢ï¼Œæ–‡ä»¶åˆ—è¡¨ï¼š"
            echo "${files_http}" | tr ' ' '\n' | awk '{print "   - " $0}'
            echo -e "\nğŸš€ å¼€å§‹æ‰§è¡ŒURLæ›¿æ¢..."
            echo "${files_http}" | xargs -r sed -i -e "s|${TARGET_OLD_URL}|${new_esc}|g"  
            echo "âœ… URLæ›¿æ¢å®Œæˆï¼å…±å¤„ç† ${replace_file_count} ä¸ªæ–‡ä»¶"
          else  
            echo "â„¹ï¸ æœªæ£€æµ‹åˆ°å« ${TARGET_OLD_URL} çš„æ–‡ä»¶ï¼Œæ— éœ€æ›¿æ¢"
          fi  

          # æ ¼å¼åŒ–é¢„è§ˆå…³é”®æ–‡ä»¶
          if [ -f "src/common.rs" ]; then  
            echo -e "\n=================================================="
            echo -e "ğŸ“„ å…³é”®æ–‡ä»¶é¢„è§ˆï¼šsrc/common.rsï¼ˆæ›¿æ¢åç›¸å…³è¡Œï¼‰"
            echo -e "=================================================="
            preview_result=$(grep -nE "${TARGET_OLD_URL}|rs\.ldxw\.top|admin-hy" src/common.rs || echo "   è¯¥æ–‡ä»¶æ— ç›¸å…³å…³é”®è¡Œ")
            echo "${preview_result}" | head -n 50 | awk '{print "   " $0}'
            echo -e "==================================================\n"
          fi  

          # æäº¤ä¿®æ”¹ï¼ˆéšè—åŸŸåï¼Œè¯­ä¹‰æ¸…æ™°ï¼‰
          if ! git diff --quiet; then  
            git add -A  
            git commit -m "chore(url): update admin HTTPS URL (total $replace_file_count files)"  
            echo "ğŸ“ å·²æäº¤ä¿®æ”¹ï¼Œcommitä¿¡æ¯ï¼šchore(url): update admin HTTPS URL (total $replace_file_count files)"
          else  
            echo "â„¹ï¸ æ— æ–‡ä»¶å†…å®¹å˜æ›´ï¼Œæ— éœ€æäº¤commit"
          fi  

          # æ›¿æ¢åæ®‹ç•™æ£€æµ‹
          echo -e "\n=================================================="
          echo -e "ğŸ” æ›¿æ¢åæ®‹ç•™æ£€æµ‹ï¼ˆæ’é™¤å­æ¨¡å—ï¼‰"
          echo -e "=================================================="
          residual_result=$(git grep -n -E "${TARGET_OLD_URL}" -- ':!:libs/hbb_common' || true)
          if [ -z "${residual_result}" ]; then  
            echo "âœ… æœªæ£€æµ‹åˆ° ${TARGET_OLD_URL} æ®‹ç•™"
          else  
            echo "âš ï¸ æ£€æµ‹åˆ°æ®‹ç•™ï¼Œç›¸å…³å†…å®¹ï¼ˆå‰20è¡Œï¼‰ï¼š"
            echo "${residual_result}" | head -n 20 | awk '{print "   " $0}'
          fi  
          echo -e "==================================================\n"

      # æ›¿æ¢dartæ–‡ä»¶ï¼ˆé€‚é…â€œåˆ é™¤å®¢æˆ·ç«¯å¹¿å‘Šæç¤ºâ€ï¼Œæ—¥å¿—ç¾åŒ–ï¼‰
      - name: Replace connection_page.dart specified code
        run: |
          set -euo pipefail
          TARGET_FILE="flutter/lib/desktop/pages/connection_page.dart"
          START_LINE=81
          END_LINE=110

          echo -e "\n=================================================="
          echo -e "ğŸ—‘ï¸ æ‰§è¡Œå®¢æˆ·ç«¯å¹¿å‘Šæç¤ºåˆ é™¤ï¼ˆä¿®æ”¹dartæ–‡ä»¶ï¼‰"
          echo -e "ğŸ“Œ ç›®æ ‡æ–‡ä»¶ï¼š${TARGET_FILE}"
          echo -e "ğŸ“Œ ä¿®æ”¹èŒƒå›´ï¼šç¬¬ ${START_LINE} - ${END_LINE} è¡Œ"
          echo -e "==================================================\n"

          # æ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "${TARGET_FILE}" ]; then
            echo -e "\n::error::âŒ ç›®æ ‡æ–‡ä»¶ ${TARGET_FILE} ä¸å­˜åœ¨ï¼Œæµç¨‹ç»ˆæ­¢"
            exit 1
          fi
          echo "âœ… æ£€æµ‹åˆ°ç›®æ ‡æ–‡ä»¶ï¼Œå¼€å§‹å‡†å¤‡ä»£ç æ›¿æ¢"

          # æ›¿æ¢å‰é¢„è§ˆï¼ˆé™åˆ¶è¡Œæ•°ï¼Œé¿å…æ—¥å¿—è¿‡é•¿ï¼‰
          echo -e "\nğŸ“‹ æ›¿æ¢å‰ï¼š${TARGET_FILE} ${START_LINE}-${END_LINE}è¡Œå†…å®¹ï¼ˆå‰10è¡Œé¢„è§ˆï¼‰"
          sed -n "${START_LINE},${END_LINE}p" "${TARGET_FILE}" | head -n 10 | awk '{print "   " $0}'
          if [ $(sed -n "${START_LINE},${END_LINE}p" "${TARGET_FILE}" | wc -l) -gt 10 ]; then
            echo "   ...ï¼ˆå†…å®¹è¿‡é•¿ï¼Œä»…æ˜¾ç¤ºå‰10è¡Œï¼‰"
          fi

          # å®šä¹‰åŸä»£ç ä¸æ›¿æ¢ä»£ç ï¼ˆä¿æŒåŸé€»è¾‘ï¼‰
          ORIGINAL_CODE=$(cat << 'EOF'
setupServerWidget() => Flexible(
child: Offstage(
offstage: !(!_svcStopped.value &&
stateGlobal.svcStatus.value == SvcStatus.ready &&
_svcIsUsingPublicServer.value),
child: Row(
crossAxisAlignment: CrossAxisAlignment.center,
children: [
Text(', ', style: TextStyle(fontSize: em)),
Flexible(
child: InkWell(
onTap: onUsePublicServerGuide,
child: Row(
children: [
Flexible(
child: Text(
translate('setup_server_tip'),
style: TextStyle(
decoration: TextDecoration.underline,
fontSize: em),
),
),
],
),
),
)
],
),
),
);
EOF
          )
          
          REPLACEMENT_CODE=$(cat << 'EOF'
Widget setupServerWidget() => Flexible(
child: Offstage(
offstage: !(!_svcStopped.value &&
stateGlobal.svcStatus.value == SvcStatus.ready &&
_svcIsUsingPublicServer.value),
child: Row(
crossAxisAlignment: CrossAxisAlignment.center,
children: [],),
),
);
EOF
          )
          
          # æ‰§è¡Œä»£ç æ›¿æ¢
          echo -e "\nğŸš€ å¼€å§‹æ‰§è¡Œ ${TARGET_FILE} ${START_LINE}-${END_LINE}è¡Œä»£ç æ›¿æ¢..."
          sed -i -e "${START_LINE},${END_LINE}d" -e "$((START_LINE-1))a '"$(echo "${REPLACEMENT_CODE}" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')"'"' "${TARGET_FILE}"
          echo "âœ… ä»£ç æ›¿æ¢å®Œæˆï¼"

          # æ›¿æ¢åé¢„è§ˆï¼ˆç¡®è®¤ç»“æœï¼‰
          echo -e "\nğŸ“‹ æ›¿æ¢åï¼š${TARGET_FILE} å…³é”®ä»£ç ç‰‡æ®µï¼ˆWidgetå®šä¹‰é™„è¿‘ï¼‰"
          grep_line=$(grep -n "Widget setupServerWidget" "${TARGET_FILE}" | awk -F: '{print $1}')
          sed -n "$((grep_line)),$((grep_line+8))p" "${TARGET_FILE}" | awk '{print "   " $0}'

          # æäº¤ä¿®æ”¹ï¼ˆé€‚é…â€œåˆ é™¤å®¢æˆ·ç«¯å¹¿å‘Šæç¤ºâ€æè¿°ï¼‰
          if ! git diff --quiet "${TARGET_FILE}"; then
            git add "${TARGET_FILE}"
            git commit -m "chore(client): åˆ é™¤å®¢æˆ·ç«¯å¹¿å‘Šæç¤ºï¼ˆä¿®æ”¹${TARGET_FILE} ${START_LINE}-${END_LINE}è¡Œï¼‰"
            echo -e "\nğŸ“ å·²æäº¤ä¿®æ”¹ï¼Œcommitä¿¡æ¯ï¼šchore(client): åˆ é™¤å®¢æˆ·ç«¯å¹¿å‘Šæç¤ºï¼ˆä¿®æ”¹${TARGET_FILE} ${START_LINE}-${END_LINE}è¡Œï¼‰"
          else
            echo -e "\nâ„¹ï¸ ${TARGET_FILE} ${START_LINE}-${END_LINE}è¡Œå·²ä¸ºç›®æ ‡ä»£ç ï¼ˆå·²åˆ é™¤å®¢æˆ·ç«¯å¹¿å‘Šæç¤ºï¼‰ï¼Œæ— éœ€æ›¿æ¢"
          fi
          echo -e "==================================================\n"

      # ï¼ˆå¯é€‰ï¼‰æ¨é€åˆ†æ”¯ï¼ˆæ—¥å¿—ç¾åŒ–ï¼‰  
      - name: Push branch (optional)  
        if: ${{ inputs.push_branch == 'true' }}  
        env:  
          GH_TOKEN: ${{ secrets.REPO_WORKFLOW_PAT }}  
        run: |  
          set -euo pipefail  
          echo -e "\n=================================================="
