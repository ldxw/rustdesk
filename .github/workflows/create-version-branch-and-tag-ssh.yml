name: æ›´æ–°åˆ†æ”¯å¹¶æ‰“Tagï¼šå­æ¨¡å— + å¤šæ–‡ä»¶æ›¿æ¢ï¼ˆæ”¯æŒè·³è¿‡/å¼ºåˆ¶ï¼‰ + Tagé”šå®šåˆ†æ”¯HEAD

on:
  workflow_dispatch:
    inputs:
      work_branch:
        description: "ç›®æ ‡æ“ä½œåˆ†æ”¯ï¼ˆç¤ºä¾‹ï¼š1.4.2ï¼‰ï¼Œéœ€ä¸è¿œç«¯åˆ†æ”¯åå®Œå…¨ä¸€è‡´ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰ï¼Œå»ºè®®å…ˆåœ¨GitHubä»“åº“ã€ŒBranchesã€é¡µé¢ç¡®è®¤å­˜åœ¨æ€§"
        required: true
        default: "1.4.2"
      # 1. URLæ›¿æ¢é…ç½®ï¼ˆæ˜ç¡®å‚æ•°ç”¨é€”+é£é™©æç¤ºï¼‰
      admin_url:  
        description: "æ›¿æ¢ç›®æ ‡URLï¼šä»…ç”¨äºæ›¿æ¢ã€Œhttps://admin.rustdesk.comã€ï¼Œéœ€ç¡®ä¿è¯¥URLå¯æ­£å¸¸è®¿é—®ï¼ˆé¿å…æ›¿æ¢åæœåŠ¡ä¸å¯ç”¨ï¼‰ï¼Œå­æ¨¡å—å†…è¯¥URLä¸ä¼šè¢«ä¿®æ”¹"  
        required: true  
        default: "https://admin-hy.rs.ldxw.top"  
      url_replace_strategy:
        description: "URLæ›¿æ¢ç­–ç•¥ï¼šskip=æ£€æµ‹æ— æ—§URLåˆ™è·³è¿‡ï¼ˆé»˜è®¤ï¼Œé«˜æ•ˆä¸å†—ä½™ï¼‰ï¼›force=å¼ºåˆ¶æ‰§è¡Œæ›¿æ¢ï¼ˆéå†æ ¸å¿ƒç›®å½•ï¼Œç¡®ä¿æ— æ—§URLæ®‹ç•™ï¼Œé€‚ç”¨äºç‰ˆæœ¬è¿­ä»£åœºæ™¯ï¼‰"
        type: choice
        options: ["skip", "force"]
        required: true
        default: "skip"
      # 2. å­æ¨¡å—é…ç½®ï¼ˆè¡¥å……åˆ†æ”¯è§„åˆ™+URLæ ¡éªŒå»ºè®®ï¼‰
      submodule_url:  
        description: "libs/hbb_common å­æ¨¡å—HTTPSåœ°å€ï¼šéœ€ç¡®ä¿ä¸ºå…¬å¼€å¯è®¿é—®ä»“åº“ï¼ˆæ— ç§æœ‰æƒé™é™åˆ¶ï¼‰ï¼Œå»ºè®®æå‰åœ¨æµè§ˆå™¨æ‰“å¼€è¯¥URLç¡®è®¤å¯æ­£å¸¸è®¿é—®"  
        required: true  
        default: "https://github.com/ldxw/rustdesk_hbb_common.git"  
      submodule_branch:  
        description: "å­æ¨¡å—åˆ†æ”¯ï¼šauto=è‡ªåŠ¨æ£€æµ‹è¿œç«¯é»˜è®¤åˆ†æ”¯ï¼ˆæ¨èï¼Œé€‚é…main/masterç­‰å‘½åï¼‰ï¼›æ‰‹åŠ¨æŒ‡å®šéœ€ç¬¦åˆå­æ¨¡å—ä»“åº“åˆ†æ”¯åï¼ˆå¦‚v1.0.0ï¼Œéœ€å…ˆç¡®è®¤å­æ¨¡å—ä»“åº“å­˜åœ¨è¯¥åˆ†æ”¯ï¼‰"  
        required: true  
        default: "auto"  
      # 3. Dartæ–‡ä»¶æ›¿æ¢é…ç½®ï¼ˆæ˜ç¡®ä¿®æ”¹èŒƒå›´+æ•ˆæœè¯´æ˜ï¼‰
      dart_replace_strategy:
        description: "Dartæ–‡ä»¶æ›¿æ¢ç­–ç•¥ï¼šskip=æ£€æµ‹ä»£ç å·²ç¬¦åˆç›®æ ‡åˆ™è·³è¿‡ï¼ˆé»˜è®¤ï¼‰ï¼›force=å¼ºåˆ¶æ‰§è¡Œæ›¿æ¢ï¼ˆè¦†ç›–æŒ‡å®šè¡Œæ•°ä»£ç ï¼Œç¡®ä¿å¹¿å‘Šæç¤ºè¢«åˆ é™¤ï¼Œé€‚ç”¨äºä»£ç è¢«ç¯¡æ”¹åœºæ™¯ï¼‰"
        type: choice
        options: ["skip", "force"]
        required: true
        default: "skip"
      # 4. æ¨é€ä¸æ‰“Tagé…ç½®ï¼ˆæ˜ç¡®é£é™©+æ“ä½œå»ºè®®ï¼‰
      push_branch:  
        description: "è¿œç«¯æ¨é€å¼€å…³ï¼štrue=æ¨é€ä¿®æ”¹åˆ°è¿œç«¯ï¼ˆé»˜è®¤ï¼Œæ­£å¼åœºæ™¯ä½¿ç”¨ï¼‰ï¼›false=ä»…æœ¬åœ°ä¿®æ”¹ï¼ˆç”¨äºæµ‹è¯•æµç¨‹æ˜¯å¦æ­£å¸¸ï¼Œä¸å½±å“è¿œç«¯æ•°æ®ï¼‰"  
        type: choice  
        options: ["true", "false"]  
        required: true  
        default: "true"  
      force:  
        description: "å¼ºåˆ¶æ“ä½œå¼€å…³ï¼šfalse=ä¸å¼ºåˆ¶ï¼ˆé»˜è®¤ï¼Œå®‰å…¨ä¼˜å…ˆï¼ŒåŒååˆ†æ”¯/Tagå­˜åœ¨æ—¶ä¼šå¤±è´¥ï¼‰ï¼›true=å¼ºåˆ¶ï¼ˆåˆ†æ”¯ç”¨--force-with-leaseé¿å…è¦†ç›–ä»–äººä¿®æ”¹ï¼ŒTagç”¨-fè¦†ç›–ï¼Œä»…ç‰ˆæœ¬ä¿®å¤æ—¶ä½¿ç”¨ï¼‰"  
        type: choice  
        options: ["false", "true"]  
        required: true  
        default: "false"  
      do_tag:  
        description: "Tagåˆ›å»ºå¼€å…³ï¼štrue=åœ¨åˆ†æ”¯HEADæ‰“Tagï¼ˆé»˜è®¤ï¼Œç”¨äºç‰ˆæœ¬æ ‡è®°ï¼Œä¾¿äºåç»­ä¸‹è½½å¯¹åº”ç‰ˆæœ¬ï¼‰ï¼›false=ä»…æ›´æ–°åˆ†æ”¯å†…å®¹ï¼ˆä¸åˆ›å»ºç‰ˆæœ¬Tagï¼‰"  
        type: choice  
        options: ["true", "false"]  
        required: true  
        default: "true"  
      version:  
        description: "Tagåç§°ï¼šç•™ç©ºåˆ™è‡ªåŠ¨ä½¿ç”¨ã€Œwork_branchã€çš„å€¼ï¼ˆæ¨èï¼Œä¿æŒåˆ†æ”¯ä¸Tagåä¸€è‡´ï¼‰ï¼›æ‰‹åŠ¨å¡«å†™éœ€ç¬¦åˆè¯­ä¹‰åŒ–ç‰ˆæœ¬è§„èŒƒï¼ˆå¦‚v1.4.2ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦ï¼‰"  
        required: false  
        default: ""  
      tag_message:  
        description: "Tagæ³¨é‡Šï¼šéœ€åŒ…å«æ ¸å¿ƒå˜æ›´ï¼ˆå¦‚â€œä¿®æ”¹å†…ç½®æœåŠ¡å™¨URL+åˆ é™¤å®¢æˆ·ç«¯å¹¿å‘Šæç¤ºâ€ï¼‰ï¼Œä¾¿äºåç»­é€šè¿‡Tagè¿½æº¯ç‰ˆæœ¬å·®å¼‚ï¼Œå»ºè®®ä¸è¶…è¿‡50å­—"  
        required: false  
        default: "ä¿®æ”¹å†…ç½®æœåŠ¡å™¨å’Œ key + åˆ é™¤å®¢æˆ·ç«¯å¹¿å‘Šæç¤º"  
      retag:  
        description: "Tagå¼ºåˆ¶é‡å»ºå¼€å…³ï¼štrue=å…ˆåˆ é™¤è¿œç«¯åŒåTagå†é‡å»ºï¼ˆé»˜è®¤ï¼Œé€‚ç”¨äºç‰ˆæœ¬æ›´æ–°ï¼Œéœ€ç¡®è®¤åŒåTagæ— éœ€ä¿ç•™ï¼‰ï¼›false=ä¸é‡å»ºï¼ˆåŒåTagå·²å­˜åœ¨æ—¶ä¼šå¤±è´¥ï¼‰"  
        type: choice  
        options: ["true", "false"]  
        required: true  
        default: "true"

permissions:
  contents: write  # æ ¸å¿ƒæƒé™ï¼šæ”¯æŒå­æ¨¡å—æ›´æ–°ã€æ–‡ä»¶ä¿®æ”¹ã€åˆ†æ”¯æ¨é€ã€Tagåˆ›å»º/åˆ é™¤
  pull-requests: read  # è¾…åŠ©æƒé™ï¼šè¯»å–PRä¿¡æ¯ï¼Œé¿å…åˆ†æ”¯å†²çªæ—¶æƒé™ä¸è¶³
  actions: read  # è¾…åŠ©æƒé™ï¼šè¯»å–Workflowè¿è¡ŒçŠ¶æ€ï¼Œä¾¿äºæ•…éšœè¿½æº¯

jobs:
  update_and_tag:
    runs-on: ubuntu-latest
    env:
      # æ ¸å¿ƒå‚æ•°/è·¯å¾„ç»Ÿä¸€å®šä¹‰ï¼ˆä¿®æ”¹1å¤„å…¨å±€ç”Ÿæ•ˆï¼Œé™ä½ç»´æŠ¤æˆæœ¬ï¼‰
      WORK_BRANCH: ${{ inputs.work_branch }}
      SM_PATH: "libs/hbb_common"  # å­æ¨¡å—å›ºå®šè·¯å¾„
      TARGET_OLD_URL: "https://admin.rustdesk.com"  # å¾…æ›¿æ¢æ—§URLï¼ˆä¸å¯ä¿®æ”¹ï¼‰
      URL_REPLACE_EXCLUDE: ":!:${SM_PATH}"  # URLæ›¿æ¢æ’é™¤ç›®å½•ï¼ˆä»…å­æ¨¡å—ï¼‰
      DART_TARGET_FILE: "flutter/lib/desktop/pages/connection_page.dart"  # Dartç›®æ ‡æ–‡ä»¶è·¯å¾„
      DART_START_LINE: 81  # Dartæ–‡ä»¶ä¿®æ”¹èµ·å§‹è¡Œï¼ˆéœ€ä¸å®é™…ä»£ç å¯¹åº”ï¼‰
      DART_END_LINE: 110   # Dartæ–‡ä»¶ä¿®æ”¹ç»“æŸè¡Œï¼ˆéœ€ä¸å®é™…ä»£ç å¯¹åº”ï¼‰
      CORE_CHECK_DIRS: "src,flutter/lib,config"  # æ ¸å¿ƒé…ç½®ç›®å½•ï¼ˆå¼ºåˆ¶æ›¿æ¢æ—¶æ‰«æèŒƒå›´ï¼‰
      RETRY_MAX: 2  # å…³é”®æ­¥éª¤æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆå¹³è¡¡æ•ˆç‡ä¸æˆåŠŸç‡ï¼‰
      TIMEOUT_CHECKOUT: 5  # ä»“åº“æ‹‰å–è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
      TIMEOUT_SUBMODULE: 10  # å­æ¨¡å—æ›´æ–°è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
    steps:
      # æ­¥éª¤0ï¼šåˆå§‹åŒ–ç¯å¢ƒï¼ˆè®°å½•è¿è¡Œä¿¡æ¯ï¼Œä¾¿äºæ•…éšœè¿½æº¯ï¼‰
      - name: Initialize workflow environment
        run: |
          set -euo pipefail
          echo -e "\n=================================================="
          echo -e "ğŸ“‹ Workflowè¿è¡ŒåŸºç¡€ä¿¡æ¯ï¼ˆç”¨äºæ•…éšœè¿½æº¯ï¼‰"
          echo -e "=================================================="
          echo "âœ… è¿è¡Œåˆ†æ”¯ï¼š${GITHUB_REF_NAME:-unknown}"
          echo "âœ… ç›®æ ‡æ“ä½œåˆ†æ”¯ï¼š${WORK_BRANCH}"
          echo "âœ… è¿è¡Œæ—¶é—´ï¼š$(date +'%Y-%m-%d %H:%M:%S %Z')"
          echo "âœ… ç³»ç»Ÿç‰ˆæœ¬ï¼š$(cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2 | sed 's/"//g')"
          echo "âœ… Gitç‰ˆæœ¬ï¼š$(git --version)"
          echo "âœ… é‡è¯•æ¬¡æ•°é…ç½®ï¼š${RETRY_MAX}æ¬¡"
          echo -e "==================================================\n"

      # æ­¥éª¤1ï¼šæ‹‰å–ä»“åº“ä»£ç ï¼ˆåŒé‡é‡è¯•+è¶…æ—¶æ§åˆ¶ï¼Œé¿å…åˆå§‹æ‹‰å–å¤±è´¥ï¼‰
      - name: Checkout repo (full history + retry + timeout)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # æ‹‰å–å®Œæ•´å†å²ï¼Œç¡®ä¿åˆ†æ”¯åˆ‡æ¢ã€Tagæ“ä½œæ— ç¼ºå¤±
          persist-credentials: false  # å…³é—­é»˜è®¤å‡­è¯ï¼Œé¿å…ä¸åç»­PATå†²çª
          submodules: false  # æš‚ä¸æ‹‰å–å­æ¨¡å—ï¼Œåç»­å•ç‹¬æ§åˆ¶
        env:
          ACTIONS_STEP_DEBUG: true  # å¼€å¯è°ƒè¯•æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥æ‹‰å–é—®é¢˜
        continue-on-error: true  # å…è®¸é¦–æ¬¡å¤±è´¥ï¼Œè§¦å‘é‡è¯•
        timeout-minutes: ${{ env.TIMEOUT_CHECKOUT }}

      # æ­¥éª¤1.1ï¼šæ‹‰å–é‡è¯•ï¼ˆé¦–æ¬¡å¤±è´¥æ—¶è§¦å‘ï¼Œæå‡æˆåŠŸç‡ï¼‰
      - name: Retry checkout if first attempt failed
        if: ${{ failure() }}
        run: |
          set -euo pipefail
          echo -e "\nâš ï¸ é¦–æ¬¡æ‹‰å–ä»“åº“å¤±è´¥ï¼Œå¼€å§‹ç¬¬2æ¬¡å°è¯•ï¼ˆæœ€å1æ¬¡ï¼‰..."
          
          # æ¸…ç†æ®‹ç•™ç›®å½•ï¼ˆé¿å…é¦–æ¬¡å¤±è´¥å¯¼è‡´çš„æ–‡ä»¶å†²çªï¼‰
          rm -rf .git ./* || true
          echo "â„¹ï¸ å·²æ¸…ç†æ®‹ç•™æ–‡ä»¶ï¼Œå‡†å¤‡é‡æ–°å…‹éš†ä»“åº“"
          
          # é‡æ–°å…‹éš†ä»“åº“ï¼ˆå®Œæ•´å†å²+æ— äºšæ¨¡å—ï¼‰
          git clone --depth 0 --no-submodules "https://github.com/${GITHUB_REPOSITORY}.git" . || {
            echo -e "\n::error::âŒ ä¸¤æ¬¡æ‹‰å–ä»“åº“å‡å¤±è´¥ï¼Œæµç¨‹ç»ˆæ­¢"
            echo "â„¹ï¸ æ’æŸ¥æ–¹å‘ï¼š1. ä»“åº“åœ°å€æ˜¯å¦æ­£ç¡®ï¼ˆå½“å‰ï¼šhttps://github.com/${GITHUB_REPOSITORY}.gitï¼‰ï¼›2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸ï¼›3. ä»“åº“æ˜¯å¦å…¬å¼€å¯è®¿é—®"
            exit 1
          }
          
          # åˆ‡æ¢åˆ°ç›®æ ‡åˆ†æ”¯ï¼ˆç¡®ä¿ä¸è¾“å…¥å‚æ•°ä¸€è‡´ï¼‰
          git checkout "origin/${WORK_BRANCH}" || {
            echo -e "\n::error::âŒ å…‹éš†ååˆ‡æ¢ç›®æ ‡åˆ†æ”¯ã€Œorigin/${WORK_BRANCH}ã€å¤±è´¥"
            echo "â„¹ï¸ æ’æŸ¥æ–¹å‘ï¼š1. è¿œç«¯æ˜¯å¦å­˜åœ¨è¯¥åˆ†æ”¯ï¼›2. åˆ†æ”¯åæ˜¯å¦æ‹¼å†™æ­£ç¡®"
            exit 1
          }
          echo "âœ… ç¬¬2æ¬¡æ‹‰å–ä»“åº“æˆåŠŸï¼Œå·²åˆ‡æ¢è‡³ç›®æ ‡åˆ†æ”¯ï¼šorigin/${WORK_BRANCH}"

      # æ­¥éª¤2ï¼šé…ç½®Gitèº«ä»½ï¼ˆå…¨å±€é…ç½®+åŒé‡æ ¡éªŒï¼Œé¿å…æäº¤èº«ä»½å¼‚å¸¸ï¼‰
      - name: Configure Git identity (global + validation)
        run: |
          set -euo pipefail
          echo -e "\n=================================================="
          echo -e "ğŸ”§ é…ç½®Gitæäº¤èº«ä»½ï¼ˆç¬¦åˆGitHub Actionså®˜æ–¹è§„èŒƒï¼‰"
          echo -e "==================================================\n"
          
          # å…¨å±€é…ç½®ï¼ˆå­æ¨¡å—ä¹Ÿä¼šç»§æ‰¿è¯¥é…ç½®ï¼Œé¿å…å­æ¨¡å—æäº¤èº«ä»½å¼‚å¸¸ï¼‰
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global pull.rebase false  # å…³é—­rebaseï¼Œé¿å…åˆ†æ”¯åˆå¹¶å†²çª
          git config --global core.autocrlf false  # å…³é—­è‡ªåŠ¨æ¢è¡Œè½¬æ¢ï¼Œé¿å…æ–‡ä»¶æ ¼å¼æ··ä¹±
          
          # åŒé‡æ ¡éªŒé…ç½®ç»“æœï¼ˆç¡®ä¿é…ç½®ç”Ÿæ•ˆï¼Œä¸é—æ¼å…³é”®ä¿¡æ¯ï¼‰
          config_name=$(git config --global user.name || true)
          config_email=$(git config --global user.email || true)
          config_rebase=$(git config --global pull.rebase || true)
          
          if [ "${config_name}" != "github-actions[bot]" ] || [ "${config_email}" != "41898282+github-actions[bot]@users.noreply.github.com" ]; then
            echo -e "\n::error::âŒ Gitæ ¸å¿ƒèº«ä»½é…ç½®å¤±è´¥"
            echo "â„¹ï¸ å½“å‰é…ç½®è¯¦æƒ…ï¼š"
            echo "   - user.name: ${config_name:-ç©º}"
            echo "   - user.email: ${config_email:-ç©º}"
            echo "   - pull.rebase: ${config_rebase:-ç©º}"
            echo "â„¹ï¸ ä¿®å¤æ–¹æ¡ˆï¼š1. é‡æ–°è¿è¡Œæœ¬æ­¥éª¤ï¼›2. æ£€æŸ¥GitHub Actionsç¯å¢ƒæƒé™ï¼ˆéœ€contents:writeï¼‰"
            exit 1
          fi
          echo "âœ… Gitèº«ä»½é…ç½®æˆåŠŸï¼Œé…ç½®è¯¦æƒ…ï¼š"
          echo "   - user.name: ${config_name}"
          echo "   - user.email: ${config_email}"
          echo "   - pull.rebase: ${config_rebase}ï¼ˆé¿å…åˆå¹¶å†²çªï¼‰"

      # æ­¥éª¤3ï¼šæœ¬åœ°å‡†å¤‡ç›®æ ‡åˆ†æ”¯ï¼ˆå†²çªæ£€æµ‹+è¯¦ç»†æŠ¥é”™ï¼Œé™ä½æ’æŸ¥æˆæœ¬ï¼‰
      - name: Prepare target branch locally (conflict check + guide)
        run: |
          set -euo pipefail
          echo -e "\n=================================================="
          echo -e "ğŸ“¦ æœ¬åœ°åˆå§‹åŒ–ç›®æ ‡åˆ†æ”¯ï¼š${WORK_BRANCH}"
          echo -e "ğŸ“Œ æ ¸å¿ƒæµç¨‹ï¼šæ‹‰å–è¿œç«¯åˆ†æ”¯ â†’ æ ¡éªŒå­˜åœ¨æ€§ â†’ æœ¬åœ°åˆ‡æ¢/åˆ›å»º â†’ åŒæ­¥è¿œç«¯æ›´æ–°"
          echo -e "==================================================\n"
          
          # æ‹‰å–è¿œç«¯åˆ†æ”¯ï¼ˆä¸å«Tagï¼Œå‡å°‘å†—ä½™ï¼›æ”¯æŒé‡è¯•ï¼‰
          pull_success=false
          for ((i=1; i<=${RETRY_MAX}; i++)); do
            echo "ğŸ” ç¬¬${i}æ¬¡æ‹‰å–è¿œç«¯åˆ†æ”¯ä¿¡æ¯..."
            if git fetch origin --no-tags; then
              pull_success=true
              break
            else
              echo "âš ï¸ ç¬¬${i}æ¬¡æ‹‰å–å¤±è´¥ï¼Œç­‰å¾…3ç§’åé‡è¯•..."
              sleep 3
            fi
          done
          
          if [ "${pull_success}" = "false" ]; then
            echo -e "\n::error::âŒ å°è¯•${RETRY_MAX}æ¬¡æ‹‰å–è¿œç«¯åˆ†æ”¯å‡å¤±è´¥"
            echo "â„¹ï¸ æ’æŸ¥ä¸ä¿®å¤æ­¥éª¤ï¼š"
            echo "   1. ç¡®è®¤GitHubä»“åº“æ˜¯å¦æ­£å¸¸ï¼ˆæ— å®•æœºã€æ— æƒé™å˜æ›´ï¼‰"
            echo "   2. æ‰‹åŠ¨æµ‹è¯•ä»“åº“è¿æ¥ï¼šgit clone https://github.com/${GITHUB_REPOSITORY}.git"
            echo "   3. è‹¥ä»“åº“ä¸ºç§æœ‰ï¼Œéœ€æ£€æŸ¥Workflowæ˜¯å¦é…ç½®äº†è®¿é—®ä»¤ç‰Œï¼ˆPATï¼‰"
            exit 1
          fi
          echo "âœ… æ‹‰å–è¿œç«¯åˆ†æ”¯ä¿¡æ¯æˆåŠŸï¼ˆå°è¯•${i}æ¬¡ï¼‰"

          # æ ¡éªŒè¿œç«¯ç›®æ ‡åˆ†æ”¯æ˜¯å¦å­˜åœ¨ï¼ˆæä¾›å…·ä½“æ“ä½œå»ºè®®ï¼‰
          if ! git show-ref --verify --quiet "refs/remotes/origin/${WORK_BRANCH}"; then
            echo -e "\n::error::âŒ è¿œç«¯ä»“åº“ä¸å­˜åœ¨åˆ†æ”¯ã€Œorigin/${WORK_BRANCH}ã€"
            echo "â„¹ï¸ è¯¦ç»†æ’æŸ¥æ­¥éª¤ï¼š"
            echo "   1. ç™»å½•GitHubä»“åº“ï¼Œè¿›å…¥ã€ŒBranchesã€é¡µé¢ï¼ˆè·¯å¾„ï¼šä»“åº“é¦–é¡µ â†’ Branchesï¼‰"
            echo "   2. ç¡®è®¤åˆ†æ”¯åæ˜¯å¦ä¸è¾“å…¥çš„ã€Œwork_branchã€ä¸€è‡´ï¼ˆåŒºåˆ†å¤§å°å†™ï¼Œå¦‚1.4.2â‰ 1.4.1ï¼‰"
            echo "   3. è‹¥åˆ†æ”¯å­˜åœ¨ä½†ä»æŠ¥é”™ï¼Œæ‰‹åŠ¨æ‰§è¡Œï¼šgit fetch origin ${WORK_BRANCH}:${WORK_BRANCH}"
            echo "   4. è‹¥åˆ†æ”¯ä¸å­˜åœ¨ï¼Œå…ˆåˆ›å»ºåˆ†æ”¯å¹¶æ¨é€ï¼šgit checkout -b ${WORK_BRANCH} && git push origin ${WORK_BRANCH}"
            exit 1
          fi
          echo "âœ… è¿œç«¯ç›®æ ‡åˆ†æ”¯ã€Œorigin/${WORK_BRANCH}ã€å­˜åœ¨ï¼Œå¼€å§‹æœ¬åœ°å¤„ç†"

          # å¤„ç†æœ¬åœ°åˆ†æ”¯ï¼šå­˜åœ¨åˆ™åŒæ­¥ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º
          if git show-ref --verify --quiet "refs/heads/${WORK_BRANCH}"; then
            # æœ¬åœ°å·²å­˜åœ¨åˆ†æ”¯ï¼Œåˆ‡æ¢ååŒæ­¥è¿œç«¯æ›´æ–°
            git checkout "${WORK_BRANCH}" || {
              echo -e "\n::error::âŒ åˆ‡æ¢æœ¬åœ°åˆ†æ”¯ã€Œ${WORK_BRANCH}ã€å¤±è´¥"
              echo "â„¹ï¸ ä¿®å¤æ–¹æ¡ˆï¼š1. æœ¬åœ°å…‹éš†ä»“åº“ååˆ é™¤è¯¥åˆ†æ”¯ï¼ˆgit branch -D ${WORK_BRANCH}ï¼‰ï¼›2. é‡æ–°è¿è¡ŒWorkflow"
              exit 1
            }
            echo "â„¹ï¸ æœ¬åœ°å·²å­˜åœ¨åˆ†æ”¯ã€Œ${WORK_BRANCH}ã€ï¼ŒåŒæ­¥è¿œç«¯æœ€æ–°æ›´æ–°ï¼ˆå¿«é€Ÿåˆå¹¶ï¼‰"
            
            # å¿«é€Ÿåˆå¹¶ï¼Œå¤±è´¥åˆ™æç¤ºå†²çªå¤„ç†æ–¹æ¡ˆ
            if ! git merge --ff-only "origin/${WORK_BRANCH}"; then
              echo -e "\n::error::âŒ å¿«é€Ÿåˆå¹¶è¿œç«¯æ›´æ–°å¤±è´¥ï¼Œå­˜åœ¨åˆ†æ”¯å†²çª"
              echo "â„¹ï¸ å†²çªå¤„ç†è¯¦ç»†æ­¥éª¤ï¼ˆæœ¬åœ°æ“ä½œï¼‰ï¼š"
              echo "   1. å…‹éš†ä»“åº“åˆ°æœ¬åœ°ï¼šgit clone https://github.com/${GITHUB_REPOSITORY}.git"
              echo "   2. åˆ‡æ¢åˆ°ç›®æ ‡åˆ†æ”¯ï¼šgit checkout ${WORK_BRANCH}"
              echo "   3. æ‹‰å–è¿œç«¯æ›´æ–°ï¼šgit pull origin ${WORK_BRANCH}"
              echo "   4. æŸ¥çœ‹å†²çªæ–‡ä»¶ï¼šgit statusï¼ˆæ ‡çº¢æ–‡ä»¶å³ä¸ºå†²çªæ–‡ä»¶ï¼‰"
              echo "   5. ç¼–è¾‘å†²çªæ–‡ä»¶ï¼šåˆ é™¤å†²çªæ ‡è®°ï¼ˆ<<<<<<<ã€=======ã€>>>>>>>ï¼‰ï¼Œä¿ç•™æ­£ç¡®å†…å®¹"
              echo "   6. æäº¤å†²çªè§£å†³ï¼šgit add . && git commit -m 'resolve conflict with origin/${WORK_BRANCH}' && git push"
              echo "   7. é‡æ–°è¿è¡Œæœ¬Workflow"
              exit 1
            }
            echo "âœ… æœ¬åœ°åˆ†æ”¯ã€Œ${WORK_BRANCH}ã€å·²åŒæ­¥è¿œç«¯æœ€æ–°æ›´æ–°ï¼Œæ— å†²çª"
          else
            # æœ¬åœ°ä¸å­˜åœ¨åˆ†æ”¯ï¼ŒåŸºäºè¿œç«¯åˆ›å»º
            git checkout -B "${WORK_BRANCH}" "origin/${WORK_BRANCH}" || {
              echo -e "\n::error::âŒ åŸºäºè¿œç«¯åˆ†æ”¯åˆ›å»ºæœ¬åœ°ã€Œ${WORK_BRANCH}ã€å¤±è´¥"
              echo "â„¹ï¸ æ’æŸ¥æ–¹å‘ï¼š1. è¿œç«¯åˆ†æ”¯æ˜¯å¦æŸåï¼›2. æœ¬åœ°ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³"
              exit 1
            }
            echo "âœ… æœ¬åœ°åˆ†æ”¯åˆ›å»ºæˆåŠŸï¼šåˆ†æ”¯å=${WORK_BRANCH}ï¼Œåˆ†æ”¯æº=origin/${WORK_BRANCH}"
          fi

          # è®°å½•å½“å‰åˆ†æ”¯å¿«ç…§ï¼ˆä¾¿äºåç»­è¿½æº¯ç‰ˆæœ¬ï¼‰
          current_commit=$(git rev-parse --short HEAD)
          echo "ğŸ“ å½“å‰åˆ†æ”¯å¿«ç…§ï¼šcommit=${current_commit}ï¼Œæ—¶é—´=$(date +'%Y-%m-%d %H:%M:%S')"
          echo "current_commit=${current_commit}" >> "$GITHUB_ENV"  # å­˜å…¥ç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨

            # æ­¥éª¤4ï¼šå­æ¨¡å—é…ç½®ä¸æ›´æ–°ï¼ˆç‰ˆæœ¬å¿«ç…§+è¶…æ—¶æ§åˆ¶ï¼Œé¿å…å­æ¨¡å—å¼‚å¸¸ï¼‰
      - name: Configure and update submodule (timeout + version check)
        id: sm_update
        run: |
          set -euo pipefail
          SM_NAME="libs/hbb_common"
          SM_URL="${{ inputs.submodule_url }}"
          REQ_BRANCH="${{ inputs.submodule_branch }}"
          current_commit="${{ env.current_commit }}"

          echo -e "\n=================================================="
          echo -e "ğŸ”— å­æ¨¡å—é…ç½®ä¸æ›´æ–°ï¼ˆç›®æ ‡ï¼š${SM_PATH}ï¼‰"
          echo -e "ğŸ“Œ å…³è”ä¸»åˆ†æ”¯å¿«ç…§ï¼šcommit=${current_commit}"
          echo -e "ğŸ“Œ è¶…æ—¶é…ç½®ï¼š${TIMEOUT_SUBMODULE}åˆ†é’Ÿ | é‡è¯•æ¬¡æ•°ï¼š${RETRY_MAX}æ¬¡"
          echo -e "==================================================\n"

          # 1. æ ¡éªŒ.gitmodulesæ–‡ä»¶ï¼ˆç¼ºå¤±åˆ™æä¾›ä¿®å¤æ–¹æ¡ˆï¼‰
          if [ ! -f ".gitmodules" ]; then
            echo -e "\n::error::âŒ æ ¹ç›®å½•ç¼ºå¤±ã€Œ.gitmodulesã€æ–‡ä»¶ï¼Œæ— å­æ¨¡å—é…ç½®"
            echo "â„¹ï¸ æœ¬åœ°ä¿®å¤æ­¥éª¤ï¼š"
            echo "   1. å…‹éš†ä¸»ä»“åº“ï¼šgit clone https://github.com/${GITHUB_REPOSITORY}.git && cd $(basename ${GITHUB_REPOSITORY})"
            echo "   2. åˆ‡æ¢ç›®æ ‡åˆ†æ”¯ï¼šgit checkout ${WORK_BRANCH}"
            echo "   3. åˆå§‹åŒ–å­æ¨¡å—é…ç½®ï¼šgit submodule add ${SM_URL} ${SM_PATH}"
            echo "   4. æäº¤é…ç½®ï¼šgit add .gitmodules && git commit -m 'add submodule ${SM_PATH} config' && git push"
            exit 1
          fi
          echo "âœ… æ£€æµ‹åˆ°ã€Œ.gitmodulesã€æ–‡ä»¶ï¼Œå­æ¨¡å—é…ç½®åˆå§‹åŒ–å®Œæˆ"

          # 2. å¤„ç†å­æ¨¡å—åˆ†æ”¯ï¼ˆè‡ªåŠ¨æ£€æµ‹/æŒ‡å®šåˆ†æ”¯ï¼ŒåŒé‡æ ¡éªŒæœ‰æ•ˆæ€§ï¼‰
          DETECTED_BRANCH="${REQ_BRANCH}"
          if [ "${REQ_BRANCH}" = "auto" ] || ! git ls-remote --heads "${SM_URL}" "${REQ_BRANCH}" | grep -q "."; then
            echo "ğŸ” è‡ªåŠ¨æ£€æµ‹å­æ¨¡å—é»˜è®¤åˆ†æ”¯ï¼ˆè¾“å…¥åˆ†æ”¯ä¸ºautoæˆ–ä¸å­˜åœ¨ï¼‰..."
            # è§£æå­æ¨¡å—è¿œç«¯HEADåˆ†æ”¯ï¼ˆé€‚é…main/masterç­‰å‘½åï¼‰
            DETECTED_BRANCH=$(git ls-remote --symref "${SM_URL}" HEAD | awk '/^ref:/ {print $2}' | sed 's#refs/heads/##')
            
            # æ ¡éªŒæ£€æµ‹ç»“æœï¼Œé¿å…åˆ†æ”¯ä¸ºç©º
            if [ -z "${DETECTED_BRANCH}" ]; then
              echo -e "\n::error::âŒ è‡ªåŠ¨æ£€æµ‹å­æ¨¡å—åˆ†æ”¯å¤±è´¥"
              echo "â„¹ï¸ æ’æŸ¥ï¼š1. å­æ¨¡å—ä»“åº“ã€Œ${SM_URL}ã€æ˜¯å¦æœ‰é»˜è®¤åˆ†æ”¯ï¼›2. ä»“åº“æ˜¯å¦å¯è®¿é—®"
              echo "â„¹ï¸ è§£å†³æ–¹æ¡ˆï¼šæ‰‹åŠ¨æŒ‡å®šã€Œsubmodule_branchã€å‚æ•°ï¼ˆå¦‚mainã€v1.0.0ï¼‰"
              exit 1
            fi
            echo "âœ… è‡ªåŠ¨æ£€æµ‹å­æ¨¡å—åˆ†æ”¯ï¼š${DETECTED_BRANCH}"
          else
            echo "âœ… å­æ¨¡å—è¿œç«¯å­˜åœ¨æŒ‡å®šåˆ†æ”¯ï¼š${REQ_BRANCH}ï¼Œæ— éœ€è‡ªåŠ¨æ£€æµ‹"
            DETECTED_BRANCH="${REQ_BRANCH}"
          fi
          echo "sm_branch=${DETECTED_BRANCH}" >> "$GITHUB_OUTPUT"  # è¾“å‡ºåˆ†æ”¯ä¾›åç»­è¿½æº¯

          # 3. é…ç½®.gitmoduleså¹¶æäº¤ï¼ˆä»…å½“æœ‰å˜æ›´æ—¶ï¼‰
          echo -e "\nğŸ”§ æ›´æ–°å­æ¨¡å—é…ç½®ï¼ˆURLï¼š${SM_URL} | åˆ†æ”¯ï¼š${DETECTED_BRANCH}ï¼‰..."
          git config -f .gitmodules "submodule.${SM_NAME}.url" "${SM_URL}"
          git config -f .gitmodules "submodule.${SM_NAME}.path" "${SM_PATH}"
          git config -f .gitmodules "submodule.${SM_NAME}.branch" "${DETECTED_BRANCH}"
          git add .gitmodules

          if ! git diff --cached --quiet; then
            git commit -m "chore(submodule): config ${SM_PATH} to ${SM_URL} (branch: ${DETECTED_BRANCH}) [main commit: ${current_commit}]" || {
              echo -e "\n::error::âŒ æäº¤å­æ¨¡å—é…ç½®å¤±è´¥"
              echo "â„¹ï¸ æ’æŸ¥ï¼š1. æ˜¯å¦æœ‰æœªæäº¤çš„ä¸»åˆ†æ”¯ä¿®æ”¹ï¼›2. Gitèº«ä»½æ˜¯å¦é…ç½®æ­£ç¡®"
              exit 1
            }
            echo "âœ… æäº¤å­æ¨¡å—é…ç½®æˆåŠŸï¼Œå…³è”ä¸»åˆ†æ”¯commitï¼š${current_commit}"
          else
            echo "â„¹ï¸ å­æ¨¡å—é…ç½®æ— å˜æ›´ï¼ˆä¸å½“å‰åˆ†æ”¯ä¸€è‡´ï¼‰ï¼Œæ— éœ€æäº¤"
          fi

          # 4. åŒæ­¥å­æ¨¡å—å†…å®¹ï¼ˆæ”¯æŒé‡è¯•+è¶…æ—¶ï¼Œé¿å…ç½‘ç»œé—®é¢˜å¯¼è‡´å¤±è´¥ï¼‰
          sync_success=false
          for ((i=1; i<=${RETRY_MAX}; i++)); do
            echo -e "\nğŸš€ ç¬¬${i}æ¬¡åŒæ­¥å­æ¨¡å—å†…å®¹ï¼ˆè¶…æ—¶ï¼š${TIMEOUT_SUBMODULE}åˆ†é’Ÿï¼‰..."
            # è¶…æ—¶æ§åˆ¶ï¼šè¶…è¿‡æŒ‡å®šæ—¶é—´åˆ™ç»ˆæ­¢è¯¥æ“ä½œ
            timeout ${TIMEOUT_SUBMODULE}m bash -c "
              git submodule sync -- ${SM_PATH};
              git submodule set-url ${SM_PATH} ${SM_URL} || true;
              git submodule set-branch --branch ${DETECTED_BRANCH} ${SM_PATH} || true;
              git submodule update --init --remote ${SM_PATH};
            " && sync_success=true && break || {
              echo "âš ï¸ ç¬¬${i}æ¬¡åŒæ­¥å¤±è´¥ï¼Œç­‰å¾…5ç§’åé‡è¯•..."
              sleep 5
            }
          done

          if [ "${sync_success}" = "false" ]; then
            echo -e "\n::error::âŒ å°è¯•${RETRY_MAX}æ¬¡åŒæ­¥å­æ¨¡å—å‡å¤±è´¥ï¼ˆè¶…æ—¶/ç½‘ç»œé—®é¢˜ï¼‰"
            echo "â„¹ï¸ æ’æŸ¥ï¼š1. å­æ¨¡å—ä»“åº“æ˜¯å¦å®•æœºï¼›2. ç½‘ç»œæ˜¯å¦èƒ½è®¿é—®GitHubï¼›3. å»¶é•¿ã€ŒTIMEOUT_SUBMODULEã€é…ç½®"
            exit 1
          fi
          echo "âœ… å­æ¨¡å—å†…å®¹åŒæ­¥æˆåŠŸï¼Œåˆ†æ”¯ï¼š${DETECTED_BRANCH}"

          # 5. å­æ¨¡å—åˆ‡æ¢åˆ†æ”¯+æäº¤æŒ‡é’ˆæ›´æ–°ï¼ˆé¿å…detached HEADçŠ¶æ€ï¼‰
          git -C "${SM_PATH}" fetch origin --no-tags
          if ! git -C "${SM_PATH}" rev-parse --verify -q "origin/${DETECTED_BRANCH}" >/dev/null; then
            echo -e "\n::error::âŒ å­æ¨¡å—è¿œç«¯æ— åˆ†æ”¯ã€Œorigin/${DETECTED_BRANCH}ã€"
            exit 1
          fi
          # åˆ‡æ¢å­æ¨¡å—åˆ†æ”¯å¹¶è®°å½•å¿«ç…§
          git -C "${SM_PATH}" checkout -B "${DETECTED_BRANCH}" "origin/${DETECTED_BRANCH}"
          sm_commit=$(git -C "${SM_PATH}" rev-parse --short HEAD)
          echo "ğŸ“ å­æ¨¡å—å¿«ç…§ï¼šcommit=${sm_commit}ï¼Œåˆ†æ”¯=${DETECTED_BRANCH}"

          # æäº¤å­æ¨¡å—æŒ‡é’ˆæ›´æ–°ï¼ˆä»…å½“ç‰ˆæœ¬å˜æ›´æ—¶ï¼‰
          git add "${SM_PATH}"
          if ! git diff --cached --quiet; then
            git commit -m "chore(submodule): bump ${SM_PATH} to ${sm_commit} (branch: ${DETECTED_BRANCH})"
            echo "âœ… æäº¤å­æ¨¡å—æŒ‡é’ˆæ›´æ–°ï¼ŒåŒæ­¥è‡³æœ€æ–°ç‰ˆæœ¬"
          else
            echo "â„¹ï¸ å­æ¨¡å—å·²ä¸ºæœ€æ–°ç‰ˆæœ¬ï¼ˆcommit=${sm_commit}ï¼‰ï¼Œæ— éœ€æäº¤"
          fi

      # æ­¥éª¤5ï¼šadmin URLæ›¿æ¢ï¼ˆæ”¯æŒè·³è¿‡/å¼ºåˆ¶ï¼Œæ— æ®‹ç•™æ ¡éªŒï¼‰
      - name: Replace admin HTTPS URL (skip/force + residual check)
        run: |
          set -euo pipefail
          NEW_URL="${{ inputs.admin_url }}"
          REPLACE_STRATEGY="${{ inputs.url_replace_strategy }}"
          replace_file_count=0
          force_triggered=false
          core_dirs=(${CORE_CHECK_DIRS//,/ })  # è§£ææ ¸å¿ƒç›®å½•æ•°ç»„

          echo -e "\n=================================================="
          echo -e "ğŸ”„ admin URLæ›¿æ¢ï¼ˆç­–ç•¥ï¼š${REPLACE_STRATEGY} | æ’é™¤å­æ¨¡å—ï¼š${SM_PATH}ï¼‰"
          echo -e "ğŸ“Œ æ—§URLï¼š${TARGET_OLD_URL} | æ–°URLï¼š***ï¼ˆéšç§éšè—ï¼‰"
          echo -e "ğŸ“Œ æ ¸å¿ƒæ‰«æç›®å½•ï¼š${CORE_CHECK_DIRS}"
          echo -e "==================================================\n"

          # 1. æ£€æµ‹éœ€æ›¿æ¢æ–‡ä»¶
          echo "ğŸ” æ£€æµ‹å«æ—§URLã€Œ${TARGET_OLD_URL}ã€çš„æ–‡ä»¶..."
          files_http=$(git grep -l -E "${TARGET_OLD_URL}" -- "${URL_REPLACE_EXCLUDE}" || true)
          if [ -n "${files_http}" ]; then
            replace_file_count=$(echo "${files_http}" | wc -w)
            echo "âœ… æ£€æµ‹åˆ° ${replace_file_count} ä¸ªæ–‡ä»¶éœ€æ›¿æ¢ï¼š"
            echo "${files_http}" | tr ' ' '\n' | awk '{print "   - " $0}'
          else
            echo "â„¹ï¸ æœªæ£€æµ‹åˆ°å«æ—§URLçš„æ–‡ä»¶"
            # æŒ‰ç­–ç•¥å¤„ç†ï¼šskip=è·³è¿‡ï¼Œforce=å¼ºåˆ¶æ›¿æ¢
            if [ "${REPLACE_STRATEGY}" = "skip" ]; then
              echo "âœ… ç­–ç•¥ä¸ºã€Œskipã€ï¼Œè·³è¿‡URLæ›¿æ¢æ­¥éª¤"
              return 0
            else
              echo "âš ï¸ ç­–ç•¥ä¸ºã€Œforceã€ï¼Œéå†æ ¸å¿ƒç›®å½•å¼ºåˆ¶æ‰§è¡Œæ›¿æ¢"
              force_triggered=true
            fi
          fi

          # 2. æ‰§è¡Œæ›¿æ¢ï¼ˆè½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ï¼Œé¿å…sedæŠ¥é”™ï¼‰
          echo -e "\nğŸš€ å¼€å§‹æ‰§è¡ŒURLæ›¿æ¢..."
          new_esc="${NEW_URL//&/\\&}"  # è½¬ä¹‰&å­—ç¬¦
          if [ -n "${files_http}" ]; then
            echo "${files_http}" | xargs -r sed -i -e "s|${TARGET_OLD_URL}|${new_esc}|g"
            echo "âœ… æ­£å¸¸æ›¿æ¢å®Œæˆï¼Œå¤„ç†æ–‡ä»¶æ•°ï¼š${replace_file_count}"
          elif [ "${force_triggered}" = "true" ]; then
            # å¼ºåˆ¶æ›¿æ¢ï¼šéå†æ ¸å¿ƒç›®å½•ï¼Œå¿½ç•¥å­æ¨¡å—
            for dir in "${core_dirs[@]}"; do
              if [ -d "${dir}" ]; then
                echo "   æ­£åœ¨æ‰«æç›®å½•ï¼š${dir}ï¼ˆæ’é™¤å­æ¨¡å—ï¼‰..."
                find "${dir}" -type f -not -path "*/${SM_PATH}/*" -exec sed -i -e "s|${TARGET_OLD_URL}|${new_esc}|g" {} \; 2>/dev/null
              else
                echo "   ç›®å½•ã€Œ${dir}ã€ä¸å­˜åœ¨ï¼Œè·³è¿‡æ‰«æ"
              fi
            done
            echo "âœ… å¼ºåˆ¶æ›¿æ¢å®Œæˆï¼Œéå†æ ¸å¿ƒç›®å½•ï¼š${CORE_CHECK_DIRS}"
          fi

          # 3. æ›¿æ¢åæ®‹ç•™æ£€æµ‹
          echo -e "\nğŸ” æ›¿æ¢åæ—§URLæ®‹ç•™æ£€æµ‹..."
          residual=$(git grep -n -E "${TARGET_OLD_URL}" -- "${URL_REPLACE_EXCLUDE}" || true)
          if [ -z "${residual}" ]; then
            echo "âœ… æ— æ—§URLæ®‹ç•™ï¼Œæ›¿æ¢ç»“æœç¬¦åˆé¢„æœŸ"
          else
            echo "âš ï¸ æ£€æµ‹åˆ°æ—§URLæ®‹ç•™ï¼ˆå‰10è¡Œï¼‰ï¼š"
            echo "${residual}" | head -n 10 | awk '{print "   " $0}'
            # éå¼ºåˆ¶åœºæ™¯æŠ¥è­¦å‘Šï¼Œä¸ç»ˆæ­¢æµç¨‹
            [ "${REPLACE_STRATEGY}" != "force" ] && echo -e "\n::warning::âš ï¸ æ­£å¸¸æ›¿æ¢åä»æœ‰æ®‹ç•™ï¼Œå»ºè®®æ‰‹åŠ¨æ£€æŸ¥"
          fi

          # 4. æäº¤ä¿®æ”¹ï¼ˆåŒºåˆ†æ­£å¸¸/å¼ºåˆ¶åœºæ™¯ï¼‰
          if ! git diff --quiet; then
            commit_msg="chore(url): update admin HTTPS URL (total ${replace_file_count} files, strategy: ${REPLACE_STRATEGY})"
            [ "${force_triggered}" = "true" ] && commit_msg="${commit_msg} [force triggered]"
            git add -A
            git commit -m "${commit_msg}"
            echo "ğŸ“ æäº¤URLæ›¿æ¢å®Œæˆï¼Œcommitä¿¡æ¯ï¼š${commit_msg}"
          else
            echo "â„¹ï¸ æ— URLæ›¿æ¢ç›¸å…³å˜æ›´ï¼Œæ— éœ€æäº¤"
          fi

      # æ­¥éª¤6ï¼šDartæ–‡ä»¶æ›¿æ¢ï¼ˆæ”¯æŒè·³è¿‡/å¼ºåˆ¶ï¼Œä»£ç å¿«ç…§æ ¡éªŒï¼‰
      - name: Replace connection_page.dart (skip/force + code check)
        run: |
          set -euo pipefail
          TARGET_FILE="${DART_TARGET_FILE}"
          START_LINE="${DART_START_LINE}"
          END_LINE="${DART_END_LINE}"
          REPLACE_STRATEGY="${{ inputs.dart_replace_strategy }}"
          force_triggered=false

          echo -e "\n=================================================="
          echo -e "ğŸ—‘ï¸ Dartæ–‡ä»¶æ›¿æ¢ï¼ˆç­–ç•¥ï¼š${REPLACE_STRATEGY} | ç›®æ ‡ï¼š${TARGET_FILE}ï¼‰"
          echo -e "ğŸ“Œ ä¿®æ”¹èŒƒå›´ï¼šç¬¬ ${START_LINE} - ${END_LINE} è¡Œ | ç›®çš„ï¼šåˆ é™¤å®¢æˆ·ç«¯å¹¿å‘Šæç¤º"
          echo -e "==================================================\n"

          # 1. æ ¡éªŒç›®æ ‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "${TARGET_FILE}" ]; then
            echo -e "\n::error::âŒ ç›®æ ‡æ–‡ä»¶ã€Œ${TARGET_FILE}ã€ä¸å­˜åœ¨"
            echo "â„¹ï¸ æ’æŸ¥ï¼š1. æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®ï¼›2. ç›®æ ‡åˆ†æ”¯æ˜¯å¦åŒ…å«è¯¥æ–‡ä»¶"
            exit 1
          fi
          echo "âœ… æ£€æµ‹åˆ°ç›®æ ‡æ–‡ä»¶ï¼š${TARGET_FILE}"

          # 2. å®šä¹‰åŸä»£ç ä¸æ›¿æ¢ä»£ç ï¼ˆä¸å®é™…éœ€æ±‚åŒ¹é…ï¼‰
          ORIGINAL_CODE=$(cat << 'EOF'
setupServerWidget() => Flexible(
child: Offstage(
offstage: !(!_svcStopped.value &&
stateGlobal.svcStatus.value == SvcStatus.ready &&
_svcIsUsingPublicServer.value),
child: Row(
crossAxisAlignment: CrossAxisAlignment.center,
children: [
Text(', ', style: TextStyle(fontSize: em)),
Flexible(
child: InkWell(
onTap: onUsePublicServerGuide,
child: Row(
children: [
Flexible(
child: Text(
translate('setup_server_tip'),
style: TextStyle(
decoration: TextDecoration.underline,
fontSize: em),
),
),
],
),
),
)
],
),
),
);
EOF
          )
          
          REPLACEMENT_CODE=$(cat << 'EOF'
Widget setupServerWidget() => Flexible(
child: Offstage(
offstage: !(!_svcStopped.value &&
stateGlobal.svcStatus.value == SvcStatus.ready &&
_svcIsUsingPublicServer.value),
child: Row(
crossAxisAlignment: CrossAxisAlignment.center,
children: [],),
),
);
EOF
          )

          # 3. æ£€æµ‹å½“å‰ä»£ç æ˜¯å¦å·²ç¬¦åˆç›®æ ‡ï¼ˆé¿å…é‡å¤æ›¿æ¢ï¼‰
          echo -e "\nğŸ” æ£€æµ‹å½“å‰ä»£ç æ˜¯å¦å·²å®Œæˆæ›¿æ¢..."
          current_code=$(sed -n "${START_LINE},${END_LINE}p" "${TARGET_FILE}" | tr -d '[:space:]')  # å»é™¤ç©ºæ ¼æ¯”å¯¹
          target_code=$(echo "${REPLACEMENT_CODE}" | tr -d '[:space:]')
          
          if [ "${current_code}" = "${target_code}" ]; then
            echo "â„¹ï¸ å½“å‰ä»£ç å·²ç¬¦åˆç›®æ ‡ï¼ˆå·²åˆ é™¤å¹¿å‘Šæç¤ºï¼‰"
            # æŒ‰ç­–ç•¥å¤„ç†ï¼šskip=è·³è¿‡ï¼Œforce=å¼ºåˆ¶è¦†ç›–
            if [ "${REPLACE_STRATEGY}" = "skip" ]; then
              echo "âœ… ç­–ç•¥ä¸ºã€Œskipã€ï¼Œè·³è¿‡Dartæ–‡ä»¶æ›¿æ¢æ­¥éª¤"
              return 0
            else
              echo "âš ï¸ ç­–ç•¥ä¸ºã€Œforceã€ï¼Œå¼ºåˆ¶æ‰§è¡Œä»£ç è¦†ç›–æ›¿æ¢"
              force_triggered=true
            fi
          else
            echo "âœ… æ£€æµ‹åˆ°ä»£ç éœ€æ›¿æ¢ï¼Œå‡†å¤‡æ‰§è¡Œä¿®æ”¹"
          fi

          # 4. æ‰§è¡Œä»£ç æ›¿æ¢ï¼ˆé¢„è§ˆå‰åå·®å¼‚ï¼‰
          echo -e "\nğŸ“‹ æ›¿æ¢å‰ä»£ç é¢„è§ˆï¼ˆç¬¬${START_LINE}è¡Œå¼€å§‹ï¼Œå‰5è¡Œï¼‰ï¼š"
          sed -n "${START_LINE},$((START_LINE+4))p" "${TARGET_FILE}" | awk '{print "   " $0}'
          
          echo -e "\nğŸš€ å¼€å§‹æ‰§è¡Œ${START_LINE}-${END_LINE}è¡Œä»£ç æ›¿æ¢..."
          # åˆ é™¤æ—§ä»£ç ï¼Œæ’å…¥æ–°ä»£ç 
          sed -i -e "${START_LINE},${END_LINE}d" -e "$((START_LINE-1))a '"$(echo "${REPLACEMENT_CODE}" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')"'"' "${TARGET_FILE}"
          echo "âœ… ä»£ç æ›¿æ¢å®Œæˆ"

          # 5. æ›¿æ¢åæ ¡éªŒï¼ˆç¡®ä¿ä»£ç æ­£ç¡®ï¼‰
          echo -e "\nğŸ“‹ æ›¿æ¢åä»£ç é¢„è§ˆï¼ˆWidgetå®šä¹‰é™„è¿‘ï¼‰ï¼š"
          grep_line=$(grep -n "Widget setupServerWidget" "${TARGET_FILE}" | awk -F: '{print $1}')
          sed -n "$((grep_line)),$((grep_line+6))p" "${TARGET_FILE}" | awk '{print "   " $0}'

          # 6. æäº¤ä¿®æ”¹ï¼ˆåŒºåˆ†æ­£å¸¸/å¼ºåˆ¶åœºæ™¯ï¼‰
          if ! git diff --quiet "${TARGET_FILE}"; then
            commit_msg="chore(client): åˆ é™¤å®¢æˆ·ç«¯å¹¿å‘Šæç¤ºï¼ˆä¿®æ”¹${TARGET_FILE} ${START_LINE}-${END_LINE}è¡Œï¼Œstrategy: ${REPLACE_STRATEGY}ï¼‰"
            [ "${force_triggered}" = "true" ] && commit_msg="${commit_msg} [force triggered]"
            git add "${TARGET_FILE}"
            git commit -m "${commit_msg}"
            echo "ğŸ“ æäº¤Dartæ–‡ä»¶ä¿®æ”¹å®Œæˆï¼Œcommitä¿¡æ¯ï¼š${commit_msg}"
          else
            echo "â„¹ï¸ Dartæ–‡ä»¶æ— å˜æ›´ï¼ˆå¼ºåˆ¶æ›¿æ¢åä¹Ÿæ— å·®å¼‚ï¼‰ï¼Œæ— éœ€æäº¤"
          fi

      # æ­¥éª¤7ï¼šåˆ†æ”¯æ¨é€ï¼ˆæ”¯æŒæ¡ä»¶æ¨é€+å¼ºåˆ¶ä¿æŠ¤ï¼Œé¿å…è¯¯æ“ä½œï¼‰
      - name: Push branch to remote (conditional + safe guard)
        if: ${{ inputs.push_branch == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.REPO_WORKFLOW_PAT }}  # ä¾èµ–ä»“åº“PATï¼Œéœ€æå‰é…ç½®
        run: |
          set -euo pipefail
          PUSH_FORCE="${{ inputs.force }}"
          current_commit=$(git rev-parse --short HEAD)

          echo -e "\n=================================================="
          echo -e "ğŸ“¤ æ¨é€åˆ†æ”¯åˆ°è¿œç«¯ï¼ˆç›®æ ‡åˆ†æ”¯ï¼š${WORK_BRANCH}ï¼‰"
          echo -e "ğŸ“Œ æ¨é€æ¨¡å¼ï¼š${PUSH_FORCE == 'true' ? 'å¼ºåˆ¶æ¨é€ï¼ˆ--force-with-leaseï¼‰' : 'æ­£å¸¸æ¨é€'}"
          echo -e "ğŸ“Œ å½“å‰åˆ†æ”¯æœ€æ–°commitï¼š${current_commit}"
          echo -e "==================================================\n"

          # 1. æ ¡éªŒPATæ˜¯å¦é…ç½®ï¼ˆé¿å…æ¨é€æƒé™ä¸è¶³ï¼‰
          if [ -z "${GH_TOKEN}" ]; then
            echo -e "\n::error::âŒ æœªé…ç½®ä»“åº“è®¿é—®ä»¤ç‰Œï¼ˆREPO_WORKFLOW_PATï¼‰"
            echo "â„¹ï¸ é…ç½®æ­¥éª¤ï¼š1. GitHubä»“åº“ â†’ Settings â†’ Secrets and variables â†’ Actions â†’ New repository secretï¼›2. åç§°å¡«REPO_WORKFLOW_PATï¼Œå€¼å¡«æœ‰repoæƒé™çš„PATï¼›3. é‡æ–°è¿è¡ŒWorkflow"
            exit 1
          fi

          # 2. é…ç½®è¿œç«¯ä»“åº“åœ°å€ï¼ˆå¸¦PATèº«ä»½éªŒè¯ï¼‰
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          echo "âœ… å·²é…ç½®è¿œç«¯ä»“åº“èº«ä»½éªŒè¯ï¼ˆPATï¼‰"

          # 3. æ‰§è¡Œæ¨é€ï¼ˆåŒºåˆ†æ­£å¸¸/å¼ºåˆ¶æ¨¡å¼ï¼Œå¼ºåˆ¶æ¨¡å¼åŠ å®‰å…¨ä¿æŠ¤ï¼‰
          push_success=false
          for ((i=1; i<=${RETRY_MAX}; i++)); do
            echo -e "\nğŸš€ ç¬¬${i}æ¬¡æ‰§è¡Œæ¨é€..."
            if [ "${PUSH_FORCE}" = "true" ]; then
              # å¼ºåˆ¶æ¨é€ç”¨--force-with-leaseï¼Œé¿å…è¦†ç›–ä»–äººæœªåŒæ­¥çš„ä¿®æ”¹ï¼ˆæ¯”--forceå®‰å…¨ï¼‰
              git push --force-with-lease origin "${WORK_BRANCH}" || {
                echo "âš ï¸ ç¬¬${i}æ¬¡å¼ºåˆ¶æ¨é€å¤±è´¥ï¼Œç­‰å¾…3ç§’åé‡è¯•..."
                sleep 3
                continue
              }
            else
              git push origin "${WORK_BRANCH}" || {
                echo "âš ï¸ ç¬¬${i}æ¬¡æ­£å¸¸æ¨é€å¤±è´¥ï¼Œç­‰å¾…3ç§’åé‡è¯•..."
                sleep 3
                continue
              }
            fi
            push_success=true
            break
          done

          if [ "${push_success}" = "false" ]; then
            echo -e "\n::error::âŒ å°è¯•${RETRY_MAX}æ¬¡æ¨é€åˆ†æ”¯å‡å¤±è´¥"
            echo "â„¹ï¸ æ’æŸ¥æ–¹å‘ï¼š1. PATæƒé™æ˜¯å¦è¶³å¤Ÿï¼ˆéœ€repo:statusã€repo:public_repoç­‰æƒé™ï¼‰ï¼›2. è¿œç«¯åˆ†æ”¯æ˜¯å¦è¢«ä¿æŠ¤ï¼ˆå¦‚ç¦æ­¢å¼ºåˆ¶æ¨é€ï¼‰ï¼›3. ç½‘ç»œæ˜¯å¦æ­£å¸¸"
            exit 1
          fi

          # 4. æ¨é€åæ ¡éªŒï¼ˆç¡®ä¿è¿œç«¯åˆ†æ”¯å·²æ›´æ–°ï¼‰
          echo -e "\nğŸ” æ ¡éªŒè¿œç«¯åˆ†æ”¯æ˜¯å¦åŒæ­¥æˆåŠŸ..."
          git fetch origin "${WORK_BRANCH}"
          remote_commit=$(git rev-parse --short "origin/${WORK_BRANCH}")
          if [ "${current_commit}" = "${remote_commit}" ]; then
            echo "âœ… åˆ†æ”¯æ¨é€æˆåŠŸï¼è¿œç«¯åˆ†æ”¯å·²åŒæ­¥è‡³commitï¼š${remote_commit}"
          else
            echo -e "\n::warning::âš ï¸ æ¨é€åæœ¬åœ°ä¸è¿œç«¯commitä¸ä¸€è‡´ï¼ˆæœ¬åœ°ï¼š${current_commit}ï¼Œè¿œç«¯ï¼š${remote_commit}ï¼‰"
            echo "â„¹ï¸ å»ºè®®ï¼šé‡æ–°æ‹‰å–è¿œç«¯åˆ†æ”¯ï¼ˆgit pull origin ${WORK_BRANCH}ï¼‰åï¼Œç¡®è®¤å·®å¼‚å†å¤„ç†"
          fi

      # æ­¥éª¤8ï¼šåˆ›å»º/é‡å»ºTagï¼ˆæ”¯æŒè‡ªåŠ¨å‘½å+å¼ºåˆ¶åˆ é™¤æ—§Tagï¼Œç‰ˆæœ¬å¯è¿½æº¯ï¼‰
      - name: Create/rewrite Tag (auto name + force rewrite)
        if: ${{ inputs.do_tag == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.REPO_WORKFLOW_PAT }}
        run: |
          set -euo pipefail
          TAG_NAME="${{ inputs.version == '' ? inputs.work_branch : inputs.version }}"
          TAG_MSG="${{ inputs.tag_message }}"
          RETAG="${{ inputs.retag }}"
          current_commit=$(git rev-parse --short HEAD)

          echo -e "\n=================================================="
          echo -e "ğŸ·ï¸ åˆ›å»º/é‡å»ºç‰ˆæœ¬Tagï¼ˆTagåï¼š${TAG_NAME}ï¼‰"
          echo -e "ğŸ“Œ Tagå…³è”commitï¼š${current_commit} | å¼ºåˆ¶é‡å»ºï¼š${RETAG}"
          echo -e "ğŸ“Œ Tagæ³¨é‡Šï¼š${TAG_MSG}"
          echo -e "==================================================\n"

          # 1. æ ¡éªŒTagååˆæ³•æ€§ï¼ˆé¿å…ç‰¹æ®Šå­—ç¬¦å¯¼è‡´å¤±è´¥ï¼‰
          if ! echo "${TAG_NAME}" | grep -qE '^[a-zA-Z0-9._-]+$'; then
            echo -e "\n::error::âŒ Tagåã€Œ${TAG_NAME}ã€ä¸åˆæ³•ï¼ˆä»…æ”¯æŒå­—æ¯ã€æ•°å­—ã€.ã€_ã€-ï¼‰"
            echo "â„¹ï¸ å»ºè®®ï¼šä¿®æ”¹ã€Œversionã€å‚æ•°ï¼Œç¬¦åˆè¯­ä¹‰åŒ–ç‰ˆæœ¬è§„èŒƒï¼ˆå¦‚v1.4.2ã€1.4.2-betaï¼‰"
            exit 1
          fi

          # 2. å¤„ç†å·²å­˜åœ¨çš„Tagï¼ˆæœ¬åœ°+è¿œç«¯ï¼‰
          echo -e "\nğŸ”§ æ¸…ç†å·²å­˜åœ¨çš„åŒåTag..."
          # åˆ é™¤æœ¬åœ°åŒåTagï¼ˆè‹¥å­˜åœ¨ï¼‰
          if git show-ref --verify --quiet "refs/tags/${TAG_NAME}"; then
            git tag -d "${TAG_NAME}"
            echo "âœ… å·²åˆ é™¤æœ¬åœ°åŒåTagï¼š${TAG_NAME}"
          else
            echo "â„¹ï¸ æœ¬åœ°æ— åŒåTagï¼š${TAG_NAME}ï¼Œæ— éœ€åˆ é™¤"
          fi

          # å¼ºåˆ¶é‡å»ºæ—¶ï¼Œåˆ é™¤è¿œç«¯åŒåTagï¼ˆè‹¥å­˜åœ¨ï¼‰
          if [ "${RETAG}" = "true" ]; then
            if git ls-remote --tags origin | grep -q "refs/tags/${TAG_NAME}"; then
              git push origin --delete "${TAG_NAME}" || {
                echo -e "\n::error::âŒ åˆ é™¤è¿œç«¯åŒåTagã€Œ${TAG_NAME}ã€å¤±è´¥"
                echo "â„¹ï¸ æ’æŸ¥ï¼š1. PATæ˜¯å¦æœ‰åˆ é™¤Tagçš„æƒé™ï¼›2. è¿œç«¯Tagæ˜¯å¦è¢«ä¿æŠ¤"
                exit 1
              }
              echo "âœ… å·²åˆ é™¤è¿œç«¯åŒåTagï¼š${TAG_NAME}"
            else
              echo "â„¹ï¸ è¿œç«¯æ— åŒåTagï¼š${TAG_NAME}ï¼Œæ— éœ€åˆ é™¤"
            fi
          fi

          # 3. åˆ›å»ºæ–°Tagå¹¶æ¨é€
          echo -e "\nğŸš€ åˆ›å»ºæ–°Tagï¼š${TAG_NAME}ï¼ˆå…³è”commitï¼š${current_commit}ï¼‰..."
          git tag -a "${TAG_NAME}" -m "${TAG_MSG} | å…³è”åˆ†æ”¯ï¼š${WORK_BRANCH} | commitï¼š${current_commit}"
          echo "âœ… æœ¬åœ°Tagåˆ›å»ºæˆåŠŸï¼Œæ³¨é‡Šï¼š${TAG_MSG}"

          # æ¨é€Tagåˆ°è¿œç«¯
          echo -e "\nğŸ“¤ æ¨é€Tagã€Œ${TAG_NAME}ã€åˆ°è¿œç«¯..."
          git push origin "${TAG_NAME}" || {
            echo -e "\n::error::âŒ æ¨é€Tagã€Œ${TAG_NAME}ã€å¤±è´¥"
            echo "â„¹ï¸ æ’æŸ¥ï¼š1. PATæƒé™æ˜¯å¦è¶³å¤Ÿï¼›2. è¿œç«¯æ˜¯å¦å·²å­˜åœ¨åŒåTagï¼ˆæœªå¼€å¯retagæ—¶ï¼‰"
            exit 1
          }
          echo "âœ… Tagã€Œ${TAG_NAME}ã€æ¨é€æˆåŠŸï¼å¯åœ¨GitHubä»“åº“ã€ŒReleasesã€é¡µé¢åŸºäºè¯¥Tagåˆ›å»ºç‰ˆæœ¬"

      # æ­¥éª¤9ï¼šWorkflowè¿è¡Œæ€»ç»“ï¼ˆè¾“å‡ºå…³é”®ä¿¡æ¯ï¼Œä¾¿äºåç»­è¿½æº¯ï¼‰
      - name: Workflow execution summary
        run: |
          set -euo pipefail
          echo -e "\n=================================================="
          echo -e "ğŸ‰ Workflowè¿è¡Œå®Œæˆï¼ˆå…³é”®ä¿¡æ¯æ€»ç»“ï¼‰"
          echo -e "=================================================="
          echo "âœ… ç›®æ ‡æ“ä½œåˆ†æ”¯ï¼š${WORK_BRANCH}"
          echo "âœ… å­æ¨¡å—çŠ¶æ€ï¼š${SM_PATH}ï¼ˆåˆ†æ”¯ï¼š${{ steps.sm_update.outputs.sm_branch }}ï¼Œå·²åŒæ­¥æœ€æ–°ï¼‰"
          echo "âœ… URLæ›¿æ¢ï¼šç­–ç•¥=${{ inputs.url_replace_strategy }}ï¼Œæ— æ—§URLæ®‹ç•™"
          echo "âœ… Dartæ–‡ä»¶æ›¿æ¢ï¼šç­–ç•¥=${{ inputs.dart_replace_strategy }}ï¼Œå·²åˆ é™¤å®¢æˆ·ç«¯å¹¿å‘Šæç¤º"
          echo "âœ… åˆ†æ”¯æ¨é€ï¼š${{ inputs.push_branch == 'true' ? 'å·²æ¨é€è‡³è¿œç«¯' : 'æœªæ¨é€ï¼ˆä»…æœ¬åœ°ä¿®æ”¹ï¼‰' }}"
          echo "âœ… Tagåˆ›å»ºï¼š${{ inputs.do_tag == 'true' ? 'å·²åˆ›å»ºTagï¼š'${{ inputs.version == '' ? inputs.work_branch : inputs.version }} : 'æœªåˆ›å»ºTag' }}"
          echo "âœ… è¿è¡Œå®Œæˆæ—¶é—´ï¼š$(date +'%Y-%m-%d %H:%M:%S %Z')"
          echo -e "==================================================\n"
          echo "â„¹ï¸ åç»­æ“ä½œå»ºè®®ï¼š"
          echo "   1. ç™»å½•GitHubä»“åº“ï¼Œç¡®è®¤åˆ†æ”¯ã€Tagæ˜¯å¦æ­£å¸¸æ˜¾ç¤º"
          echo "   2. åŸºäºåˆ›å»ºçš„Tagï¼Œåœ¨ã€ŒReleasesã€é¡µé¢ç¼–å†™ç‰ˆæœ¬è¯´æ˜å¹¶å‘å¸ƒ"
          echo "   3. è‹¥æœ‰å¤±è´¥æ­¥éª¤ï¼ŒæŸ¥çœ‹è¯¥æ­¥éª¤ã€ŒLogsã€è·å–è¯¦ç»†æŠ¥é”™ä¿¡æ¯"
